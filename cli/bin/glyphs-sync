#!/usr/bin/env node

const parseArgs = require('minimist')
const path = require('path')
const inquirer = require('inquirer')
const { log, PRINT } = require('../utils/logger')
const { localConfigs, hasConfig } = require('../utils/config')

const args = process.argv.slice(2)
const argv = parseArgs(args, {
  alias: {
    d: 'data',
    s: 'svg',
    j: 'json',
    p: 'preview',
    h: 'help'
  },
  boolean: ['h', 'p'],
  string: ['S', 'd', 's']
})

if (argv.help) {
  PRINT.SYNC.HELP()
  process.exit()
}

;(async () => {
  log()
  let { _: [query], preview: generatePreview } = argv
  let key

  if (!hasConfig) {
    PRINT.SYNC.NO_CONFIG()
    process.exit(1)
  }

  if (query) {
    const fileConf = query in localConfigs
      ? localConfigs[query]
      : Object.values(localConfigs).find(({ name }) =>
        name.toLowerCase().includes(query.toLowerCase()))

    if (fileConf) {
      key = fileConf.key
    } else {
      PRINT.SYNC.NOT_FOUND(({ query }))
      query = null
    }
  }

  if (!query) {
    if (Object.keys(localConfigs).length > 1) {
      const choices = Object.entries(localConfigs)
        .map(([key, { name }]) => ({ value: key, name }))
      const questions = [
        { type: 'list', name: 'name', message: 'Select the file to sync', choices }
      ]

      const answers = await inquirer.prompt(questions)
      key = answers.name
    } else {
      key = Object.keys(localConfigs)[0]
    }
  }

  const syncArgs = {
    data: 'data',
    svg: 'svg',
    json: 'json',
    ...argv,
    key
  }

  const sync = require('../lib/sync')

  const run = async () => {
    log()
    await sync(syncArgs).catch(handleError)
    if (generatePreview) {
      const dataDir = path.join(process.cwd(), syncArgs.data)
      require('../lib/preview')(dataDir)
    }
    log()
    process.exit()
  }

  run()
})()

function handleError (err) {
  log()
  log(err.message)
  process.env.NODE_ENV === 'dev' && log(err)
  log()
  process.exit(1)
}
